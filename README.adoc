= Lab4 - Creating Images Using Running Containers
tip-caption: üí° TIP
:warning-caption: ‚ö†Ô∏è WARNING

Our microservices are currently running inside containers from Lab 3. However, if we stop one of them, we lose all the manual changes we made (installing Python, Flask, copying code) because those changes only exist on the container's **writable layer**.

=== Restarting Containers (if needed)

Run the following commands to restart the containers if they were removed after stopping in the previous lab.

[source,shell]
----
$ podman start inventory_service
$ podman start order_service
$ podman start customer_service
$ podman start billing_service
----

To retain their current state permanently and create a reusable artifact, we must **commit** the changes to a new image.

== 1. Committing Containers to New Images

The `podman commit` command creates a new image by flattening the container's current state (including the writable layer where we installed dependencies and copied files) into a new, read-only image layer.

=== Commit Running Containers

Run the following commands to create permanent images from the running containers. We tag them with `:manual` to signify their origin.

[source,shell]
----
$ podman commit inventory_service inventory_image:manual
$ podman commit order_service order_image:manual
$ podman commit customer_service customer_image:manual
$ podman commit billing_service billing_image:manual
----

=== Verify the New Images

We now have four new images based on the Fedora base layer, but with all application prerequisites baked in:

[source,shell]
----
$ podman images
REPOSITORY                          TAG         IMAGE ID      CREATED             SIZE
localhost/billing_image             manual      5a57576464cc  About a minute ago  480 MB
localhost/customer_image            manual      4984b299abcc  About a minute ago  479 MB
localhost/order_image               manual      1686fcc661b5  About a minute ago  480 MB
localhost/inventory_image           manual      c795e24d0157  About a minute ago  480 MB
# ... and the original fedora image plus others ...
----

== 2. Running Services from the Custom Images

Since the containers from Lab 3 used the `--rm` flag, they will be automatically deleted when stopped. We will now run new containers using our custom images.

=== Stop and Verify Cleanup

Stop all currently running containers (if any are left from previous lab).

[source,shell]
----
$ podman stop -a
$ podman ps
CONTAINER ID  IMAGE      COMMAND    CREATED    STATUS    PORTS      NAMES
# Output should be empty
----

=== Launch Services Using the New Images

We no longer need to execute `/bin/bash`. Instead, we specify the application's command (`python3 service.py`) directly, as the dependencies are guaranteed to exist within the image itself.

[source,shell]
----
$ podman run --name inventory_service --network host -d localhost/inventory_image:manual python3 inventory_service.py
$ podman run --name order_service --network host -d localhost/order_image:manual python3 order_service.py
$ podman run --name customer_service --network host -d localhost/customer_image:manual python3 customer_service.py
$ podman run --name billing_service --network host -d localhost/billing_image:manual python3 billing_service.py
----

NOTE: When running the containers, we must explicitly state the application command (`python3 service.py`) because we haven't yet defined a formal **ENTRYPOINT** or **CMD** in a `Containerfile`.

== 3. Testing the Immutable Images

The application should function identically to the end of Lab 2/Fix, but the setup process has been significantly simplified.

=== Verify Connectivity

Use a free terminal to verify the Inventory Service (Port 5001) is running:

[source,shell]
----
$ curl http://127.0.0.1:5001/view_inventory
{"inventory":{...}} 
----

=== Cross-Service Validation (Order Placement)

Verify that the Order Service (Port 5002) can still communicate with the Inventory Service (Port 5001) to check stock.

[source,shell]
----
# Attempt to place a valid order
$ curl -X POST \
    -H "Content-Type: application/json" \
    -d '{"customer_id": "customer_id_1", "medicine": "medicine_A", "quantity": 5}' \
    http://localhost:5002/place_order

# Verify the order exists on port 5002
$ curl http://127.0.0.1:5002/view_orders
----

== 4. Conclusion

We have successfully transitioned to running our microservices from **immutable images**. This means that if you destroy and restart the containers, the application prerequisites and code are instantly available, demonstrating the core principle of repeatable deployment.

== 5. Terminating the Lab

WARNING: Terminate the services before moving to the next lab.

[source,shell]
----
$ podman stop -a
----