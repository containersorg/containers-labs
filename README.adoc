= Lab 11 - Securing our Application (Secrets Management)
:tip-caption: üí° TIP
:warning-caption: ‚ö†Ô∏è WARNING

The final step in containerization is ensuring we handle sensitive data (like credentials) securely, preventing them from being accidentally committed to source code or exposed in deployment commands.

== 1.Hardcoded Credentials (Insecure Base)

The initial version of our application, `auth.py`, contains the credentials hardcoded within the script itself.

=== Local Testing

Test the local script to confirm the expected behavior:

[source,shell]
----
$ python3 authentication.py
Enter your username: fakename
Enter your password: fakepassword
Error: Invalid username or password. Authentication failed.

$ python3 authentication.py
Enter your username: user123
Enter your password: password123
Welcome, user123! Authentication successful.
----

=== Containerizing the Insecure App

Build and run the containerized version using the `authContainerfile` and the `auth.py`.

[source,shell]
----
$ podman build -t authenticator:v1 -f authContainerfile .
$ podman run --rm -ti --name authenticator localhost/authenticator:v1
Enter your username: user123
Enter your password: password123
Welcome, user123! Authentication successful.
----

NOTE: This is the least secure approach. Anyone viewing the source code knows the password.

== 2. Environment Variables (Better, but Exposed)

We improve security by modifying the application to read credentials from **environment variables**, removing them from the source code. The updated file is located in `solution/auth.py`.

. Copy the updated code and rebuild the image:
[source,shell]
----
$ cp solution/auth.py authentication.py
$ podman build -t authenticator:v2 -f authContainerfile .
----

=== Running with Exposed Variables

We are now passing the credentials in clear text when running the container.

[source,shell]
----
# WARNING: This exposes secrets via the 'podman inspect' command!
$ podman run --rm -ti --name authenticator \
    -e VALID_USERNAME=user123 -e VALID_PASSWORD=password123 \
    localhost/authenticator:v2
Enter your username: user123
Enter your password: password123
Welcome, user123! Authentication successful.
----

WARNING: Although the secret is not in the source code, it is still visible to any user who can run `podman inspect` on the host machine. This is **unacceptable** for true secrets. 

== 3. Utilizing Podman Secrets (Secure Production Method) üèÜ

To avoid exposing the real values in the clear text command history or via `podman inspect`, we utilize Podman's built-in secrets management functionality.

=== Create Secrets on the Host

We create secure, dedicated secrets storage for the username and password.

[source,shell]
----
$ printf "user123" | podman secret create username -
2fc833daa70b54c79f2dbce5c

$ printf "password123" | podman secret create password -
d7b9dff4f0d87bfb77401e2a4
----

Now we can list our secrets

[source,shell]
----
$ podman secret list
ID                         NAME        DRIVER      CREATED             UPDATED
2fc833daa70b54c79f2dbce5c  username    file        About a minute ago  About a minute ago
d7b9dff4f0d87bfb77401e2a4  password    file        About a minute ago  About a minute ago
----

=== Launch Container Using Secrets

We run the container, instructing Podman to map the secure secret storage to the application's required environment variables (`VALID_USERNAME`, `VALID_PASSWORD`) at runtime. The secrets themselves are never visible on the command line.

[source,shell]
----
$ podman run --rm -ti --name authenticator \
    --secret=username,type=env,target=VALID_USERNAME \
    --secret=password,type=env,target=VALID_PASSWORD \
    localhost/authenticator:v2
Enter your username: user123
Enter your password: password123
Welcome, user123! Authentication successful
----

This final stage is the **most secure practice** for container deployment, ensuring sensitive data is protected using the platform's native secrets management features.

== 4. Terminating the Lab

[source,shell]
----
$ podman rm authenticator
$ podman secret rm username password
----
