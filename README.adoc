= Lab 5 - Improving Image Efficiency (Single Image Source)
:tip-caption: üí° TIP
:warning-caption: ‚ö†Ô∏è WARNING

Wait! Why did we create four different images in the previous lab when we know that the only difference between them is the *command* we run and the *port*? The dependencies (Python, Flask, Requests) are identical. Why not create a single image with all the code and selectively run each service instead?

This process is highly recommended because it:

.  **Saves Disk Space:** The base layer containing the OS and Python dependencies is only stored once.
.  **Simplifies Updates:** To patch Python, you only rebuild one image, not four.
.  **Encapsulates Code:** All application source code lives in a single, version-controlled unit.

== 1. Consolidating Source Code and Dependencies

We will now commit a new image, `pharmacy:manual`, that contains *all* application source code.

=== Verify Current Code State

Select the running `inventory_service` container from Lab 4 and inspect its file list. (If it's not running, start it again with the same command as in Lab 4.)

[source,shell]
----
$ podman exec -ti inventory_service ls -l | grep .py
-rw-r--r--. 1 root root 363 Jan 13 20:04 inventory_service.py
----

=== Copy All Missing Source Code

We are missing the other three service files. Copy all of them into the running `inventory_service` container:

[source,shell]
----
$ podman cp billing_service.py inventory_service:/
$ podman cp customer_service.py inventory_service:/
$ podman cp order_service.py inventory_service:/
----

Verify the files are now present:

[source,shell]
----
$ podman exec -ti inventory_service ls -l | grep .py
-rw-r--r--. 1 root root 363 Jan 13 20:04 billing_service.py
-rw-r--r--. 1 root root 363 Jan 13 20:04 customer_service.py
-rw-r--r--. 1 root root 363 Jan 13 20:04 inventory_service.py
-rw-r--r--. 1 root root 363 Jan 13 20:04 order_service.py
----

=== Commit the Unified Image

This running container now has all the dependencies and all the application code. Let's build our unified image and call it `pharmacy`.

[source,shell]
----
$ podman commit inventory_service pharmacy:manual
----

== 2. Cleanup and Image Management

Before testing the unified image, we clean up the previous, redundant individual images.

=== Stop Running Containers

[source,shell]
----
$ podman stop -a
$ podman ps
CONTAINER ID  IMAGE      COMMAND    CREATED    STATUS    PORTS      NAMES
# Output should be empty
----

=== Remove Redundant Images

Remove the four individual service images created in Lab 4.

[source,shell]
----
$ podman rmi localhost/billing_image:manual localhost/customer_image:manual localhost/order_image:manual localhost/inventory_image:manual
----

TIP: This command saves considerable disk space, as those four images shared most of their base layers but duplicated the final layers.

== 3. Testing the Unified Image Deployment

We will now run all services again, but every container will be instantiated from the *same* `pharmacy:manual` image. The command passed at runtime determines which service is activated.

=== Launch All Services from the Single Image

[source,shell]
----
$ podman run --rm --name inventory_service --network host -d localhost/pharmacy:manual python3 inventory_service.py
$ podman run --rm --name order_service --network host -d localhost/pharmacy:manual python3 order_service.py
$ podman run --rm --name customer_service --network host -d localhost/pharmacy:manual python3 customer_service.py
$ podman run --rm --name billing_service --network host -d localhost/pharmacy:manual python3 billing_service.py
----

Notice that now, with a **single image**, we are running all four services, which is much more efficient and easier to manage in a registry.

Verify all containers are running:

[source,shell]
----
$ podman ps
CONTAINER ID  IMAGE                      COMMAND               CREATED         STATUS         PORTS       NAMES
cd62d8ad0429  localhost/pharmacy:manual  python3 inventory...  36 seconds ago  Up 36 seconds              inventory_service
e9621db33efa  localhost/pharmacy:manual  python3 order_ser...  31 seconds ago  Up 31 seconds              order_service
dee656a4e663  localhost/pharmacy:manual  python3 customer_...  27 seconds ago  Up 28 seconds              customer_service
b5bc1352919e  localhost/pharmacy:manual  python3 billing_s...  23 seconds ago  Up 23 seconds              billing_service
----

=== Final Application Test

Use a free terminal to verify the Order Service (Port 5002) is running and can communicate with Inventory (Port 5001).

[source,shell]
----
# Place a test order (requires communication between services)
$ curl -X POST \
    -H "Content-Type: application/json" \
    -d '{"customer_id": "customer_id_1", "medicine": "medicine_A", "quantity": 5}' \
    http://localhost:5002/place_order

# Verify the order exists
$ curl http://127.0.0.1:5002/view_orders
----

== 4. Terminating the Lab

WARNING: Terminate the services before moving to the next lab.

[source,shell]
----
$ podman stop -a
----
