= Lab 5 - Improving the scenario

Wait! Why do we have to create four different images when we know that the only difference between them is a single Python file containing the service's source code? Why don’t we create a single image with all the code and selectively run each service instead?

To accomplish this select any of the running containers, and instead of having only one Python script copied let’s copy all the source code in this container

We can see what we have in the container:

[source,shell]
----
$ podman exec -ti inventory_service ls -l *.py
ls: cannot access 'billing_service.py': No such file or directory
ls: cannot access 'customer_service.py': No such file or directory
ls: cannot access 'order_service.py': No such file or directory
-rw-r--r--. 1 root root 363 Jan 13 20:04 inventory_service.py
----

We are missing three files, let’s add them:

[source,shell]
----
$ podman cp billing_service.py inventory_service:/
$ podman cp customer_service.py inventory_service:/
$ podman cp order_service.py inventory_service:/
----

Now this running container has all the dependencies and all the application code, let’s build our image and call it `pharmacy`, with the `manual` tag because we are creating it manually:

[source,shell]
----
$ podman commit inventory_service pharmacy:manual
----

We can once again stop all the running containers, and we can also delete the individual images created before:

[source,shell]
----
$ podman stop -a
$ podman rmi localhost/billing_image:manual localhost/customer_image:manual localhost/order_image:manual localhost/inventory_image:manual
----

Now run all the containers, but this time using the `pharmacy:manual` image.

[source,shell]
----
$ podman run --rm --name inventory_service --network host -d localhost/pharmacy:manual python3 inventory_service.py
$ podman run --rm --name order_service --network host -d localhost/pharmacy:manual python3 order_service.py
$ podman run --rm --name customer_service --network host -d localhost/pharmacy:manual python3 customer_service.py
$ podman run --rm --name billing_service --network host -d localhost/pharmacy:manual python3 billing_service.py
----

Notice that now, with a single image, we are running all the services, which is easier to control and definitely more efficient.

image::commit.png[400,400,align=center]