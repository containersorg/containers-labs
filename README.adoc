= Lab 12 - Using Compose for the Pharmacy Application
:tip-caption: üí° TIP
:warning-caption: ‚ö†Ô∏è WARNING

We have advanced significantly in the creation of our application, but we are still handling deployment manually. Manually running four containers with complex flags (`--network`, `-p`, `-v`) is tedious and prone to error.

To automate the entire application stack deployment and lifecycle, we will use **Compose** (via `podman-compose` or `docker-compose`).

Ensure all running containers are stopped and removed as well as defined networks.

[source,shell]
----
$ podman rm -fa
$ podman network remove pharmacy
----

== 1. Prerequisites

Ensure you have either `podman-compose` or `docker-compose` installed and the final `v5`, unified image ready.

[source,shell]
----
$ sudo dnf install -y podman-compose
----

== 2. Defining the Application Stack (compose.yml)

The `compose.yml` file declaratively defines all parts of our application: services, networking, and persistent volumes. We are using the unified `pharmacy:v5` image.

== 3. Deployment and Lifecycle Management

Compose manages the creation of volumes, networks, and containers automatically based on the `compose.yml` file.

=== Bring Services Up

Bring our services up in detached mode. Compose will automatically create the network, create the volume, and start all four containers simultaneously.

[source,shell]
----
$ podman-compose up -d
----

NOTE: Notice that new networks, volumes, and containers were created, all typically prepended with the name of our project directory.

[source,shell]
----
$ podman container ls
$ podman network ls
$ podman pod ls
$ podman volume ls
----

=== Verify Application Health

Verify connectivity and the complex workflow (Order $\rightarrow$ Inventory) is working:

[source,shell]
----
# 1. Test external access (Inventory Service 5001)
$ curl http://127.0.0.1:5001/view_inventory

# 2. Place an order via port 5002 (Tests persistence and inter-service communication)
$ curl -X POST \
    -H "Content-Type: application/json" \
    -d '{"customer_id": "customer_id_1", "medicine": "medicine_A", "quantity": 5}' \
    http://localhost:5002/place_order
----

=== Bring Services Down and Clean Up

Use the following command to stop and remove all services, cleaning up the network as well.

[source,shell]
----
$ podman-compose down
----

== 4. Best Practice: Tagging and Versioning

When versioning, constantly updating the tag in the `compose.yml` file (e.g., changing from `:v5` to `:v6`) is tedious. A better practice is to maintain a `latest` tag that always points to the current production-ready version.

[source,shell]
----
$ podman tag localhost/pharmacy:v5 localhost/pharmacy:latest
----

You can then change the `image` entry in your `compose.yml` to `image: localhost/pharmacy:latest`, ensuring you only update the tag once when you build a new version, not every time you deploy.
